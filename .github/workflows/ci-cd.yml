name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate application
      run: |
        echo "ðŸ” Validating Quiz App..."
        echo "Files found:"
        ls -la index.html style.css script.js questions.json
        
        # Quick validation
        if ! grep -q "quiz\|Quiz" index.html; then
          echo "âš ï¸  'Quiz' not found in index.html"
        fi
        
        echo "âœ… Validation complete"
    
    - name: Test with different ports
      run: |
        # Create a test script
        cat > test-ports.sh << 'EOF'
        #!/bin/bash
        echo "Testing on multiple ports..."
        
        for port in 5000 5001 6000 7000 8000; do
          echo "Trying port $port..."
          if ! lsof -i :$port > /dev/null; then
            echo "âœ… Port $port is available"
            AVAILABLE_PORT=$port
            break
          fi
        done
        
        if [ -z "$AVAILABLE_PORT" ]; then
          echo "âŒ No ports available"
          exit 1
        fi
        
        echo "Using port: $AVAILABLE_PORT"
        EOF
        
        chmod +x test-ports.sh
        ./test-ports.sh
    
    - name: Build status badge
      if: success()
      run: echo "âœ… Build passed on $(date)"
      
  package:
    name: Create Deployment Package
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Create AWS Deployment Package
      run: |
        echo "ðŸ“¦ Creating AWS deployment package..."
        
        # Create folder structure
        mkdir -p aws-package
        
        # Web files
        cp index.html aws-package/
        cp style.css aws-package/
        cp script.js aws-package/
        cp questions.json aws-package/
        
        # AWS deployment guide
        cat > aws-package/AWS_DEPLOYMENT.md << 'EOF'
        # AWS Deployment Guide
        
        ## Method 1: S3 Static Website (Recommended)
        1. Go to AWS S3 Console
        2. Create bucket: quiz-app-[yourname]
        3. Upload ALL files from this folder
        4. Properties â†’ Static website hosting â†’ Enable
        5. Set index.html as index document
        6. Permissions â†’ Bucket policy â†’ Add:
        
        ```json
        {
          "Version": "2012-10-17",
          "Statement": [{
            "Sid": "PublicRead",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::YOUR-BUCKET-NAME/*"
          }]
        }
        ```
        
        7. Your URL: http://bucket-name.s3-website-us-east-1.amazonaws.com
        
        ## Method 2: AWS Amplify
        1. Go to AWS Amplify Console
        2. Connect GitHub repository
        3. Automatic deployment
        4. Wait 5 minutes
        
        ## Method 3: EC2 with Docker
        1. Launch EC2 t2.micro
        2. Install Docker
        3. Upload files
        4. Run: docker run -d -p 80:3000 quiz-app
        EOF
        
        # Create ZIP
        zip -r quiz-app-aws.zip aws-package/
        
        echo "âœ… Package created: quiz-app-aws.zip"
        ls -lh quiz-app-aws.zip
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: quiz-app-deployment
        path: quiz-app-aws.zip
        retention-days: 7
    
    - name: Deployment summary
      run: |
        echo "## ðŸš€ Deployment Ready!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your Quiz App has been packaged for AWS deployment!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Download the package from Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ AWS Console Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to [AWS S3 Console](https://s3.console.aws.amazon.com)" >> $GITHUB_STEP_SUMMARY
        echo "2. Create bucket with unique name" >> $GITHUB_STEP_SUMMARY
        echo "3. Upload all files from the package" >> $GITHUB_STEP_SUMMARY
        echo "4. Enable static website hosting" >> $GITHUB_STEP_SUMMARY
        echo "5. Your app will be live!" >> $GITHUB_STEP_SUMMARY